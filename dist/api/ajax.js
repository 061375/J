"use strict";import{Constants}from"../init.js";import{Public}from"../init.js";import*as J from"../root.js";export default{};export class Base{constructor(t,e={}){this._url=t,this.dataloading=!1,this.throttle=!1,this.contentType="application/json",this.dataType="json",e.hasOwnProperty("contentType")&&(this.contentType=null==e?void 0:e.contentType),e.hasOwnProperty("dataType")&&(this.dataType=null==e?void 0:e.dataType)}get(t,e={},o=(()=>{})){if(!(this.dataloading&&this.throttle||Public.ISERRORING||"SendErrors"==t)){for(const t in e)e.hasOwnProperty(t)&&t.startsWith("orad")&&(e[t]=J.Root.DTDateToOracle(e[t]));this.dataloading=!0,"json"==this.dataType?this.getData(this._url+t,{data:void 0===e?{}:e}).then((t=>{if(this.dataloading=!1,this.throttle=!1,1==(null==t?void 0:t.update)&&J.$("#updatemessage").addClass("show"),2==(null==t?void 0:t.update)&&(console.log("update !!!!!"),window.location.reload()),3==(null==t?void 0:t.update)&&(console.log("error !!!","The program threw an error that is causing the system to request that all server requests stop or the admin has requested that the server stop making requests"),Public.ISERRORING=!0),void 0===(null==t?void 0:t.redirect)||""==(null==t?void 0:t.redirect)||null==(null==t?void 0:t.redirect))if(1!=(null==t?void 0:t.success))if(void 0!==(null==t?void 0:t.softerror))if(1!=t.softerror)if(void 0!==(null==t?void 0:t.errors)&&null!==(null==t?void 0:t.errors)){var e="";Object.entries(t.errors).forEach((([t,o])=>{e+=o+"\n"})),Constants.SUPPRESSALERTERROR||J.Debug.ErrorHandler("An Ajax error occured [1] ",e)}else Constants.SUPPRESSALERTERROR||J.Debug.ErrorHandler("An Ajax error occured [2] ",null==t?void 0:t.message),Public.ISERRORING=!0;else"function"==typeof o&&o(null==t?void 0:t.message);else Public.ISERRORING=!0;else"function"==typeof o&&(t.allowstring?o(null==t?void 0:t.message):o(JSON.parse(null==t?void 0:t.message)));else window.location=null==t?void 0:t.redirect})).catch((t=>{this.dataloading=!1,this.throttle=!1,J.Debug.ErrorHandler(t)})):this.getJsonPData(this._url,{data:void 0===e?{}:e}).then((t=>{this.dataloading=!1,this.throttle=!1,"function"==typeof o&&o(t)})).catch((t=>{this.dataloading=!1,this.throttle=!1,J.Debug.ErrorHandler(t)}))}}getData(t,e){return new Promise(((o,s)=>{const r=new XMLHttpRequest;r.open("POST",t,!0),r.setRequestHeader("Content-Type",this.contentType),r.setRequestHeader("Cache-Control","no-cache"),r.setRequestHeader("X-MainPage-Hash",J.$("#ajaxhash").val().get()),r.onreadystatechange=()=>{if(r.readyState===XMLHttpRequest.DONE)if(200===r.status){const t=JSON.parse(r.responseText);o(JSON.parse(null==t?void 0:t.d))}else{const t=new Error("Request failed with status: "+r.status);s(t)}};try{r.send(JSON.stringify(e))}catch(t){s(t)}}))}getJsonPData(t,e){return new Promise(((o,s)=>{const r="jsonpCallback_"+Math.random().toString(36).substr(2,9);-1==t.indexOf("?")&&(t+="?");const a=document.createElement("script");a.src=`${t}&callback=${r}&data=${JSON.stringify(e)}`,document.body.appendChild(a),window[r]=t=>{if(document.body.removeChild(a),delete window[r],t)o(t);else{const t=new Error("JSONP request failed");s(t)}}}))}SetThrottle(){this.throttle=!0}}const activeAjaxRequests=function(t){var e=0;return XMLHttpRequest.prototype.send=function(o){e++,this.addEventListener("readystatechange",(function(){4===this.readyState&&e--})),t.call(this,o)},()=>e}(XMLHttpRequest.prototype.send);